<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FinMate</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/admin-dashboard.css" rel="stylesheet">
    <script src="../assets/js/helper_functions.js"></script>
    <script src="../assets/js/autho_helper.js" defer></script>
    <script src="../assets/js/sidebar.js" defer></script>
</head>
<body>
    <div class="app-container">
        <!-- Include sidebar component -->
        <div id="sidebar-container"></div>
        
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Header Section -->
            <header class="admin-header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 class="header-title">Admin Dashboard</h1>
                        <div class="header-subtitle">System overview and management</div>
                    </div>
                    <div class="header-right">
                        <div class="admin-profile">
                            <div class="admin-avatar">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="admin-info">
                                <span class="admin-name" id="adminName">Admin</span>
                                <span class="admin-role">Administrator</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Dashboard Content -->
            <div class="dashboard-content">
                <!-- Statistics Overview -->
                <section class="stats-section">
                    <h2 class="section-title">System Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <h3 class="stat-number" id="totalUsers">0</h3>
                                    <p class="stat-label">Total Users</p>
                                </div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="usersChange">+0%</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <h3 class="stat-number" id="totalTransactions">0</h3>
                                    <p class="stat-label">Total Transactions</p>
                                </div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="transactionsChange">+0%</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <h3 class="stat-number" id="totalRevenue">$0</h3>
                                    <p class="stat-label">Total Revenue</p>
                                </div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="revenueChange">+0%</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>

                        <div class="stat-card info">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <h3 class="stat-number" id="premiumUsers">0</h3>
                                    <p class="stat-label">Premium Users</p>
                                </div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="premiumChange">+0%</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions & Recent Activity -->
                <div class="dashboard-grid">
                    <!-- Quick Actions -->
                    <section class="quick-actions-section">
                        <h3 class="section-subtitle">Quick Actions</h3>
                        <div class="quick-actions-grid">
                            <a href="user-management.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-users-cog"></i>
                                </div>
                                <div class="action-content">
                                    <h4>User Management</h4>
                                    <p>Manage user accounts and permissions</p>
                                </div>
                            </a>

                            <div class="action-card" onclick="exportData()">
                                <div class="action-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="action-content">
                                    <h4>Export Data</h4>
                                    <p>Download system reports and data</p>
                                </div>
                            </div>

                            <div class="action-card" onclick="systemSettings()">
                                <div class="action-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="action-content">
                                    <h4>System Settings</h4>
                                    <p>Configure system parameters</p>
                                </div>
                            </div>

                            <a href="system-log.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="action-content">
                                    <h4>System Logs</h4>
                                    <p>View system activity and logs</p>
                                </div>
                            </a>
                        </div>
                    </section>

                    <!-- Recent Activity -->
                    <section class="recent-activity-section">
                        <h3 class="section-subtitle">Recent Activity</h3>
                        <div class="activity-list" id="recentActivity">
                            <!-- Activities will be loaded here -->
                        </div>
                    </section>
                </div>

                <!-- System Status -->
                <section class="system-status-section">
                    <h3 class="section-subtitle">System Status</h3>
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-header">
                                <h4>Database</h4>
                                <div class="status-indicator online"></div>
                            </div>
                            <p class="status-info">All database connections are healthy</p>
                        </div>

                        <div class="status-card">
                            <div class="status-header">
                                <h4>API Services</h4>
                                <div class="status-indicator online"></div>
                            </div>
                            <p class="status-info">All API endpoints are responding</p>
                        </div>

                        <div class="status-card">
                            <div class="status-header">
                                <h4>Payment System</h4>
                                <div class="status-indicator online"></div>
                            </div>
                            <p class="status-info">Payment processing is operational</p>
                        </div>

                        <div class="status-card">
                            <div class="status-header">
                                <h4>Server Load</h4>
                                <div class="status-indicator warning"></div>
                            </div>
                            <p class="status-info">Moderate load - 65% CPU usage</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication and admin role when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('userData');
            
            if (!token || !userData) {
                console.log('[AUTH] No token or user data found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            console.log('[AUTH] Checking authentication status and admin role');
            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/verify-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error('[AUTH] Error parsing response:', e);
                    redirectToLogin();
                    return;
                }

                if (data.code !== 1000) {
                    console.log('[AUTH] Token verification failed:', data.message);
                    redirectToLogin();
                    return;
                }

                // Check if user has ADMIN role
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userRole = payload.scope;
                    console.log('[AUTH] User role from token:', userRole);
                    
                    if (userRole !== 'ADMIN') {
                        console.log('[AUTH] Access denied: User does not have ADMIN role');
                        alert('Access denied. This page is only available for administrators.');
                        window.location.href = 'home.html';
                        return;
                    }
                } catch (e) {
                    console.error('[AUTH] Error parsing token payload:', e);
                    redirectToLogin();
                    return;
                }

                // Authentication successful and user is admin
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.display = 'flex';

                // Update admin info
                const userInfo = JSON.parse(userData);
                const adminName = userInfo.name || userInfo.email.split('@')[0];
                document.getElementById('adminName').textContent = adminName;
                
                currentUser = userInfo;

                // Load sidebar for admin
                loadSideBarSimple(adminName);

                // Load dashboard data
                await loadDashboardData();

            } catch (error) {
                console.error('[AUTH] Error verifying token:', error);
                redirectToLogin();
            }
        });

        function redirectToLogin() {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadSystemStats(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadSystemStats() {
            try {
                const token = localStorage.getItem('token');
                
                // Load users data
                const usersResponse = await fetch('http://localhost:8080/api/admin/users?page=0&size=1000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    const users = usersData.content;
                    
                    // Calculate statistics
                    const totalUsers = users.length;
                    const premiumUsers = users.filter(u => u.isPremium && !u.isDelete).length;
                    const activeUsers = users.filter(u => !u.isDelete).length;
                    const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
                    const lastLoginActiveUsers = users.filter(u => {
                        if (u.isDelete) return false;
                        const lastLoginDate = u.lastLoginAt ? new Date(u.lastLoginAt) : null;
                        return lastLoginDate && lastLoginDate >= thirtyDaysAgo;
                    }).length;
                    
                    // Update UI with real data
                    document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
                    document.getElementById('premiumUsers').textContent = premiumUsers.toLocaleString();
                    
                    // Calculate estimated transactions and revenue based on real data
                    const estimatedTransactions = totalUsers * 8 + premiumUsers * 12; // Premium users make more transactions
                    const estimatedRevenue = premiumUsers * 29.99 + activeUsers * 2.5; // Estimated monthly revenue
                    
                    document.getElementById('totalTransactions').textContent = estimatedTransactions.toLocaleString();
                    document.getElementById('totalRevenue').textContent = `$${estimatedRevenue.toFixed(2)}`;
                    
                    // Get previous stats for percentage calculation
                    const prevStats = JSON.parse(localStorage.getItem('adminStats') || '{}');
                    
                    // Calculate percentage changes
                    const usersChange = calculateChange(prevStats.totalUsers, totalUsers);
                    const premiumChange = calculateChange(prevStats.premiumUsers, premiumUsers);
                    const transactionsChange = calculateChange(prevStats.transactions, estimatedTransactions);
                    const revenueChange = calculateChange(prevStats.revenue, estimatedRevenue);
                    
                    // Update percentage displays
                    document.getElementById('usersChange').textContent = formatPercentage(usersChange);
                    document.getElementById('premiumChange').textContent = formatPercentage(premiumChange);
                    document.getElementById('transactionsChange').textContent = formatPercentage(transactionsChange);
                    document.getElementById('revenueChange').textContent = formatPercentage(revenueChange);
                    
                    // Save current stats for next time
                    const currentStats = {
                        totalUsers: totalUsers,
                        premiumUsers: premiumUsers,
                        transactions: estimatedTransactions,
                        revenue: estimatedRevenue
                    };
                    localStorage.setItem('adminStats', JSON.stringify(currentStats));
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
            }
        }

        async function loadRecentActivity() {
            const activities = [
                {
                    icon: 'fas fa-user-plus',
                    title: 'New user registered',
                    description: 'john.doe@example.com joined the platform',
                    time: '5 minutes ago',
                    type: 'user'
                },
                {
                    icon: 'fas fa-credit-card',
                    title: 'Premium subscription activated',
                    description: 'User upgraded to premium plan',
                    time: '12 minutes ago',
                    type: 'payment'
                },
                {
                    icon: 'fas fa-exclamation-triangle',
                    title: 'System alert',
                    description: 'High CPU usage detected on server 2',
                    time: '1 hour ago',
                    type: 'alert'
                },
                {
                    icon: 'fas fa-cog',
                    title: 'System maintenance completed',
                    description: 'Database optimization finished successfully',
                    time: '2 hours ago',
                    type: 'system'
                },
                {
                    icon: 'fas fa-users',
                    title: 'Bulk user import',
                    description: '150 users imported from CSV file',
                    time: '3 hours ago',
                    type: 'user'
                }
            ];

            const activityList = document.getElementById('recentActivity');
            activityList.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">
                        <i class="${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <h4 class="activity-title">${activity.title}</h4>
                        <p class="activity-description">${activity.description}</p>
                        <span class="activity-time">${activity.time}</span>
                    </div>
                </div>
            `).join('');
        }

        // Quick action functions
        function exportData() {
            alert('Export functionality will be implemented here');
        }

        function systemSettings() {
            alert('System settings panel will be implemented here');
        }

        function viewLogs() {
            alert('System logs viewer will be implemented here');
        }

        // Helper functions for percentage calculation
        function calculateChange(oldValue, newValue) {
            if (!oldValue || oldValue === 0) {
                return newValue > 0 ? 15 : 0; // Default positive growth
            }
            return ((newValue - oldValue) / oldValue) * 100;
        }

        function formatPercentage(change) {
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(1)}%`;
        }
    </script>
</body>
</html> 