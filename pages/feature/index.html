<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feature Management - FinMate</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/assets/js/autho_helper.js" defer></script>
    <script src="/assets/js/helper_functions.js" defer></script>
    <script src="/assets/js/sidebar.js" defer></script>
    <style>
        :root {
            --primary: #0d9488;
            --primary-dark: #0c7a6e;
            --primary-light: #ccfbf1;
            --text-dark: #1e293b;
            --text-light: #6b7280;
            --success: #0d9488;
            --error: #dc2626;
            --warning: #f59e0b;
        }

        body {
            background: linear-gradient(135deg, #f0fdf4, #e5f7fb);
        }

        .table-row-hover {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .table-row-hover:hover {
            background-color: rgba(13, 148, 136, 0.1);
            transform: translateY(-2px);
        }

        .action-icon {
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .action-icon:hover {
            transform: scale(1.3);
        }

        .view-icon:hover {
            color: var(--primary);
        }

        .edit-icon:hover {
            color: var(--warning);
        }

        .delete-icon:hover {
            color: var(--error);
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }

        .modal-content.show {
            transform: scale(1);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes notificationSlideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }

        .notification-slide-in {
            animation: notificationSlideIn 0.3s ease-out;
        }

        .notification-slide-out {
            animation: notificationSlideOut 0.3s ease-in;
        }
    </style>
</head>

<body class="font-sans text-gray-900">
    <div class="flex min-h-screen">
        <div id="sidebar-container"></div>
        <main class="flex-1 md:ml-64 p-6 transition-all">
            <header
                class="bg-gradient-to-r from-teal-600 to-lime-400 rounded-2xl p-5 shadow-lg flex flex-col md:flex-row justify-between items-center mb-6 card-hover">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-3xl font-extrabold text-white">Feature Management</h1>
                    <div class="text-sm text-white opacity-80" id="current-date-time"></div>
                </div>
                <div class="relative flex-1 max-w-md mx-4">
                    <input type="text" id="searchInput" placeholder="Search features..." aria-label="Search features"
                        class="w-full p-3 pl-4 pr-10 border border-gray-200 rounded-full bg-white focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary-light)] transition shadow-sm" />
                    <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-[var(--text-light)]"></i>
                </div>
                <div class="flex items-center gap-3">
                    <button
                        class="bg-white text-[var(--primary)] px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition flex items-center gap-2 shadow-sm"
                        id="createBtn">
                        <i class="fas fa-plus"></i> Create Feature
                    </button>
                    <button
                        class="bg-white text-[var(--primary)] px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition flex items-center gap-2 shadow-sm"
                        id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="menuToggle" class="p-3 rounded-full bg-white hover:bg-gray-100 md:hidden shadow-sm">
                        <i class="fas fa-bars text-[var(--primary)]"></i>
                    </button>
                </div>
            </header>
            <div class="bg-white rounded-2xl p-6 shadow-lg w-full mb-6 card-hover">
                <h2 class="text-xl font-semibold text-[var(--text-dark)] mb-4">Feature Statistics</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-4 bg-teal-50 rounded-xl text-center shadow-sm">
                        <p class="text-sm text-[var(--text-light)]">Total Features</p>
                        <p class="text-2xl font-bold text-[var(--text-dark)]" id="totalFeatures">0</p>
                    </div>
                    <div class="p-4 bg-teal-50 rounded-xl text-center shadow-sm">
                        <p class="text-sm text-[var(--text-light)]">Active Features</p>
                        <p class="text-2xl font-bold text-[var(--text-dark)]" id="activeFeatures">0</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-lg w-full card-hover">
                    <div class="flex justify-between items-center mb-5 pb-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-[var(--text-dark)] flex items-center gap-2">
                            <i class="fas fa-filter text-[var(--primary)]"></i> Filter Features
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="codeFilter" class="block text-sm font-medium text-[var(--text-dark)]">Feature
                                Code</label>
                            <input type="text" id="codeFilter" placeholder="E.g., FEATURE01"
                                class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm" />
                        </div>
                        <div>
                            <label for="isActiveFilter"
                                class="block text-sm font-medium text-[var(--text-dark)]">Status</label>
                            <select id="isActiveFilter"
                                class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm">
                                <option value="">All</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label for="nameFilter" class="block text-sm font-medium text-[var(--text-dark)]">Feature
                                Name</label>
                            <input type="text" id="nameFilter" placeholder="E.g., Payment Gateway"
                                class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm" />
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg w-full card-hover">
                    <div class="flex justify-between items-center mb-5 pb-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-[var(--text-dark)] flex items-center gap-2">
                            <i class="fas fa-cogs text-[var(--primary)]"></i> Feature Entries
                        </h2>
                        <button
                            class="bg-gradient-to-r from-teal-600 to-lime-400 text-white px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition flex items-center gap-2 shadow-sm"
                            id="filterBtn">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="featuresTable" class="w-full text-center">
                            <thead class="bg-gray-100 text-[var(--text-light)]">
                                <tr>
                                    <th class="p-3 font-semibold text-sm rounded-tl-xl">#</th>
                                    <th class="p-3 font-semibold text-sm">Code</th>
                                    <th class="p-3 font-semibold text-sm">Name</th>
                                    <th class="p-3 font-semibold text-sm">Status</th>
                                    <th class="p-3 font-semibold text-sm rounded-tr-xl">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="featuresBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="pagination" class="flex justify-center mt-4 gap-2">
                        <button
                            class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                            id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers"></div>
                        <button
                            class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                            id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Create/Edit Feature Modal -->
            <div id="featureModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[1000]">
                <div
                    class="bg-white bg-opacity-95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-lg relative modal-content">
                    <button onclick="closeFeatureModal()"
                        class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-[var(--primary)] transition">×</button>
                    <h3 class="text-2xl font-bold text-[var(--text-dark)] mb-6 flex items-center gap-2">
                        <i class="fas fa-cogs text-[var(--primary)]"></i> <span id="modalTitle">Create Feature</span>
                    </h3>
                    <form id="featureForm">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label for="code" class="block text-sm font-medium text-[var(--text-dark)]">Feature
                                    Code</label>
                                <input type="text" id="code" name="code" maxlength="50"
                                    class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm" />
                            </div>
                            <div>
                                <label for="name" class="block text-sm font-medium text-[var(--text-dark)]">Feature
                                    Name</label>
                                <input type="text" id="name" name="name" maxlength="255"
                                    class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm" />
                            </div>
                            <div>
                                <label for="description"
                                    class="block text-sm font-medium text-[var(--text-dark)]">Description</label>
                                <textarea id="description" name="description" maxlength="255"
                                    class="w-full p-3 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-[var(--primary-light)] focus:border-[var(--primary)] transition shadow-sm"></textarea>
                            </div>
                            <div>
                                <label for="isActive"
                                    class="block text-sm font-medium text-[var(--text-dark)]">Active</label>
                                <input type="checkbox" id="isActive" name="isActive"
                                    class="w-5 h-5 rounded border-gray-200 text-[var(--primary)] focus:ring-[var(--primary-light)]" />
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button"
                                class="bg-gray-200 text-[var(--text-dark)] px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition shadow-sm"
                                onclick="closeFeatureModal()">Cancel</button>
                            <button type="submit"
                                class="bg-gradient-to-r from-teal-600 to-lime-400 text-white px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition shadow-sm">Save</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Feature Details Modal -->
            <div id="featureDetailModal"
                class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[1000]">
                <div
                    class="bg-white bg-opacity-95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-lg relative modal-content">
                    <button onclick="closeFeatureDetailModal()"
                        class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-[var(--primary)] transition">×</button>
                    <h3 class="text-2xl font-bold text-[var(--text-dark)] mb-6 flex items-center gap-2">
                        <i class="fas fa-info-circle text-[var(--primary)]"></i> Feature Details
                    </h3>
                    <div id="featureDetailsContent" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    <div class="mt-6 flex justify-end">
                        <button
                            class="bg-gradient-to-r from-teal-600 to-lime-400 text-white px-5 py-2 rounded-xl hover:shadow-xl hover:-translate-y-1 transition shadow-sm"
                            onclick="closeFeatureDetailModal()">Close</button>
                    </div>
                </div>
            </div>
            <div id="toastContainer" class="fixed top-4 right-4 z-[1000] space-y-2 w-[320px] max-w-full"></div>
        </main>
    </div>
    <script>
        let currentPage = 0;
        let totalPages = 0;

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date-time').textContent = now.toLocaleString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', timeZoneName: 'short', timeZone: 'Asia/Ho_Chi_Minh'
            });
        }

        // Save and load filters
        function saveFilters(code, name, isActive) {
            localStorage.setItem('featureFilters', JSON.stringify({ code, name, isActive }));
        }

        function loadFilters() {
            const filters = JSON.parse(localStorage.getItem('featureFilters') || '{}');
            document.getElementById('codeFilter').value = filters.code || '';
            document.getElementById('nameFilter').value = filters.name || '';
            document.getElementById('isActiveFilter').value = filters.isActive || '';
            return filters;
        }

        // Load feature statistics
        async function loadStats() {
            try {
                const response = await apiRequest('http://localhost:8080/api/features/stats');
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                const features = data.result;
                console.log(features);
                const totalFeatures = features.totalFeatures;
                const activeFeatures = features.activeFeatures; // Assuming FeatureStatsResponse uses totalActives
                document.getElementById('totalFeatures').textContent = totalFeatures || 0;
                document.getElementById('activeFeatures').textContent = activeFeatures || 0;
            } catch (error) {
                showNotification('Error', 'Failed to load stats. Please try again.', 'error');
                console.error('Error loading stats:', error);
            }
        }

        // Load features with pagination and sorting (for filter button)
        async function loadFeatures(page = 0, size = 10) {
            try {
                const url = `http://localhost:8080/api/features/filter?page=${page}&size=${size}&sortBy=code&sortDirection=DESC`;
                const response = await apiRequest(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.result || !data.result.content) throw new Error('Data format incorrect');
                const features = data.result.content;
                totalPages = data.result.totalPages || 1;
                currentPage = page;
                console.log(features);
                const tbody = document.getElementById('featuresBody');
                tbody.innerHTML = '';
                features.forEach((feature, index) => {
                    const featureId = feature.id; // Fallback to index-based ID
                    const count = (index + 1 + page * size);
                    const tr = document.createElement('tr');
                    tr.className = 'table-row-hover';
                    tr.innerHTML = `
                    <td class="p-3">${count}</td>
                    <td class="p-3">${feature.featureCode || 'N/A'}</td>
                    <td class="p-3">${feature.featureName || 'N/A'}</td>
                    <td class="p-3">${feature.active ? 'Active' : 'Inactive'}</td>
                    <td class="p-3">
                        <button class="action-icon view-icon mx-2" onclick="showFeatureDetails(${featureId})" title="View Details">
                            <i class="fas fa-eye text-teal-600 hover:text-teal-800"></i>
                        </button>
                        <button class="action-icon edit-icon mx-2" onclick="editFeature(${featureId})" title="Edit">
                            <i class="fas fa-edit text-yellow-600 hover:text-yellow-800"></i>
                        </button>
                        <button class="action-icon delete-icon mx-2" onclick="deleteFeature(${featureId})" title="Delete">
                            <i class="fas fa-trash text-red-600 hover:text-red-800"></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                renderPagination();
                showNotification('Success', 'Features loaded successfully!', 'success');
            } catch (error) {
                showNotification('Error', `Failed to load features: ${error.message}`, 'error');
                console.error('Error loading features:', error);
            }
        }

        // Search features with filtering and pagination (for search input)
        async function searchFeatures(page = 0, size = 10, code = '', name = '', isActive = '') {
            try {
                const searchRequest = {
                    featureCode: code || null,
                    featureName: name || null,
                    isActive: isActive !== '' ? isActive === 'true' : null,
                    page,
                    size,
                    sortBy: 'code',
                    sortDirection: 'DESC'
                };
                const response = await apiRequest('http://localhost:8080/api/features/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(searchRequest)
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.result || !data.result.content) throw new Error('Data format incorrect');

                console.log("search: ", data.result);
                const features = data.result.content;
                totalPages = data.result.totalPages || 1;
                currentPage = page;

                const tbody = document.getElementById('featuresBody');
                tbody.innerHTML = '';
                features.forEach((feature, index) => {
                    const featureId = feature.id || (index + 1 + page * size); // Fallback to index-based ID
                    const tr = document.createElement('tr');
                    tr.className = 'table-row-hover';
                    tr.innerHTML = `
                    <td class="p-3">${featureId}</td>
                    <td class="p-3">${feature.featureCode || 'N/A'}</td>
                    <td class="p-3">${feature.featureName || 'N/A'}</td>
                    <td class="p-3">${feature.active ? 'Active' : 'Inactive'}</td>
                    <td class="p-3">
                        <button class="action-icon view-icon mx-2" onclick="showFeatureDetails(${featureId})" title="View Details">
                            <i class="fas fa-eye text-teal-600 hover:text-teal-800"></i>
                        </button>
                        <button class="action-icon edit-icon mx-2" onclick="editFeature(${featureId})" title="Edit">
                            <i class="fas fa-edit text-yellow-600 hover:text-yellow-800"></i>
                        </button>
                        <button class="action-icon delete-icon mx-2" onclick="deleteFeature(${featureId})" title="Delete">
                            <i class="fas fa-trash text-red-600 hover:text-red-800"></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                renderPagination();
                showNotification('Success', 'Features loaded successfully!', 'success');
            } catch (error) {
                showNotification('Error', `Failed to load features: ${error.message}`, 'error');
                console.error('Error loading features:', error);
            }
        }

        // Refresh data
        async function refreshData() {
            const filters = loadFilters();
            await Promise.all([
                loadFeatures(0, 10),
                loadStats()
            ]);
        }

        // Show feature details
        async function showFeatureDetails(featureId) {
            if (!featureId) {
                showNotification('Error', 'Invalid feature ID.', 'error');
                console.error('Invalid featureId:', featureId);
                return;
            }
            try {
                const response = await apiRequest(`http://localhost:8080/api/features/${featureId}`);
                if (!response.ok) throw new Error('Failed to load feature details');
                const feature = (await response.json()).result;
                document.getElementById('featureDetailsContent').innerHTML = `
                <div class="col-span-2 flex items-center gap-3 p-4 border rounded-lg bg-teal-50 shadow-sm">
                    <i class="fas fa-code text-teal-600 text-lg"></i>
                    <div>
                        <p class="text-sm text-[var(--text-light)]">Feature Code</p>
                        <p class="font-semibold text-[var(--text-dark)]">${feature.featureCode || 'N/A'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-4 border rounded-lg bg-green-50 shadow-sm">
                    <i class="fas fa-tag text-green-600 text-lg"></i>
                    <div>
                        <p class="text-sm text-[var(--text-light)]">Feature Name</p>
                        <p class="font-semibold text-[var(--text-dark)]">${feature.featureName || 'N/A'}</p>
                    </div>
                </div>
                <div class="col-span-2 flex items-start gap-3 p-4 border rounded-lg bg-yellow-50 shadow-sm">
                    <i class="fas fa-info-circle text-yellow-600 text-lg"></i>
                    <div>
                        <p class="text-sm text-[var(--text-light)]">Description</p>
                        <p class="font-semibold text-[var(--text-dark)]">${feature.featureDescription || 'N/A'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-4 border rounded-lg bg-purple-50 shadow-sm">
                    <i class="fas fa-toggle-on text-purple-600 text-lg"></i>
                    <div>
                        <p class="text-sm text-[var(--text-light)]">Status</p>
                        <p class="font-semibold text-[var(--text-dark)]">${feature.active ? 'Active' : 'Inactive'}</p>
                    </div>
                </div>
            `;
                const modal = document.getElementById('featureDetailModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => modal.querySelector('.modal-content').classList.add('show'), 10);
            } catch (error) {
                showNotification('Error', 'Failed to load feature details. Please try again.', 'error');
                console.error('Error loading feature details:', error);
            }
        }

        // Close feature detail modal
        function closeFeatureDetailModal() {
            const modal = document.getElementById('featureDetailModal');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        // Open create/edit feature modal
        function openFeatureModal(feature = null) {
            const modal = document.getElementById('featureModal');
            const form = document.getElementById('featureForm');
            const title = document.getElementById('modalTitle');
            form.reset();
            if (feature) {
                title.textContent = 'Edit Feature';
                document.getElementById('code').value = feature.featureCode || '';
                document.getElementById('name').value = feature.featureName || '';
                document.getElementById('description').value = feature.featureDescription || '';
                document.getElementById('isActive').checked = feature.active || false;
                form.dataset.featureId = feature.id;
            } else {
                title.textContent = 'Create Feature';
                delete form.dataset.featureId;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.querySelector('.modal-content').classList.add('show'), 10);
        }

        // Close feature modal
        function closeFeatureModal() {
            const modal = document.getElementById('featureModal');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        // Edit feature
        async function editFeature(featureId) {
            if (!featureId) {
                showNotification('Error', 'Invalid feature ID.', 'error');
                console.error('Invalid featureId:', featureId);
                return;
            }
            try {
                const response = await apiRequest(`http://localhost:8080/api/features/${featureId}`);
                if (!response.ok) throw new Error('Failed to load feature');
                const feature = (await response.json()).result;
                openFeatureModal(feature);
            } catch (error) {
                showNotification('Error', 'Failed to load feature. Please try again.', 'error');
                console.error('Error loading feature:', error);
            }
        }

        // Delete feature
        async function deleteFeature(featureId) {
            if (!featureId) {
                showNotification('Error', 'Invalid feature ID.', 'error');
                console.error('Invalid featureId:', featureId);
                return;
            }
            if (!confirm('Are you sure you want to delete this feature?')) return;
            try {
                const response = await apiRequest(`http://localhost:8080/api/features/${featureId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Delete failed');
                showNotification('Success', 'Feature deleted successfully!', 'success');
                const filters = loadFilters();
                loadFeatures(currentPage, 10);
            } catch (error) {
                showNotification('Error', 'Failed to delete feature. Please try again.', 'error');
                console.error('Error deleting feature:', error);
            }
        }

        // Render pagination
        function renderPagination() {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            const maxButtons = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons);
            startPage = Math.max(0, endPage - maxButtons);

            const createButton = (page, text, disabled = false) => {
                return `<button class="px-4 py-2 rounded-lg ${disabled ? 'bg-gray-300 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'} text-white transition" ${disabled ? 'disabled' : `onclick="loadFeatures(${page}, 10)"`}>${text}</button>`;
            };

            const buttons = [
                ...(startPage > 0 ? [createButton(0, '1'), ...(startPage > 1 ? ['<span class="px-4 py-2 text-gray-500">...</span>'] : [])] : []),
                ...Array.from({ length: endPage - startPage }, (_, i) => createButton(startPage + i, startPage + i + 1, startPage + i === currentPage)),
                ...(endPage < totalPages ? [(endPage < totalPages - 1 ? '<span class="px-4 py-2 text-gray-500">...</span>' : ''), createButton(totalPages - 1, totalPages)] : []),
            ];

            pageNumbers.innerHTML = buttons.join('');
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
        }

        // Show notification
        function showNotification(title, message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const notificationCard = document.createElement('div');
            notificationCard.className = `mb-3 notification-slide-in ${type === 'error' ? 'bg-red-50 text-red-800' : type === 'warning' ? 'bg-yellow-50 text-yellow-800' : 'bg-green-50 text-green-800'}`;
            const iconPaths = {
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
                warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />',
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
            };
            notificationCard.innerHTML = `
            <div class="rounded-lg p-3 shadow-sm transition-all duration-300 text-sm">
                <div class="flex items-start space-x-2">
                    <svg class="w-4 h-4 mt-0.5 ${type === 'error' ? 'text-red-600' : type === 'warning' ? 'text-yellow-600' : 'text-green-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${iconPaths[type]}
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-semibold leading-snug">${title}</h3>
                        <p class="mt-0.5 leading-snug">${message}</p>
                    </div>
                </div>
            </div>
        `;
            toastContainer.appendChild(notificationCard);
            setTimeout(() => {
                notificationCard.classList.remove('notification-slide-in');
                notificationCard.classList.add('notification-slide-out');
                setTimeout(() => notificationCard.remove(), 300);
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            if (!checkAuth()) return;

            const user = getCurrentUser();
            if (user) {
                const userInfo = JSON.parse(localStorage.getItem('userData') || '{}');
                const userName = userInfo.name || userInfo.email?.split('@')[0] || 'Admin';
                loadSideBarSimple(userName);
                await loadFeatures(0, 10);
                await loadStats();
            }

            // Search input handler
            document.getElementById('searchInput').addEventListener('input', debounce(() => {
                const searchTerm = document.getElementById('searchInput').value;
                const filters = loadFilters();
                searchFeatures(0, 10, searchTerm || filters.code, searchTerm || filters.name, filters.isActive);
            }, 500));

            // Filter button handler
            document.getElementById('filterBtn').addEventListener('click', () => {
                const code = document.getElementById('codeFilter').value;
                const name = document.getElementById('nameFilter').value;
                const isActive = document.getElementById('isActiveFilter').value;
                saveFilters(code, name, isActive);
                searchFeatures(0, 10, code, name, isActive);
                loadStats();
            });

            // Pagination handlers
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadFeatures(currentPage, 10);
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    loadFeatures(currentPage, 10);
                }
            });

            // Refresh button handler
            document.getElementById('refreshBtn').addEventListener('click', refreshData);

            // Create feature button handler
            document.getElementById('createBtn').addEventListener('click', () => openFeatureModal());

            // Form submission handler
            document.getElementById('featureForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const featureId = form.dataset.featureId;
                const featureData = {
                    code: form.code.value,
                    name: form.name.value,
                    description: form.description.value,
                    isActive: form.isActive.checked
                };
                try {
                    const method = featureId ? 'PUT' : 'POST';
                    const url = featureId ? `http://localhost:8080/api/features/${featureId}` : 'http://localhost:8080/api/features';
                    const response = await apiRequest(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(featureData)
                    });
                    if (!response.ok) throw new Error(featureId ? 'Failed to update feature' : 'Failed to create feature');
                    showNotification('Success', featureId ? 'Feature updated successfully!' : 'Feature created successfully!', 'success');
                    closeFeatureModal();
                    loadStats();
                    loadFeatures(currentPage, 10);
                } catch (error) {
                    showNotification('Error', featureId ? 'Failed to update feature. Please try again.' : 'Failed to create feature. Please try again.', 'error');
                    console.error('Error saving feature:', error);
                }
            });
        });
    </script>
</body>

</html>