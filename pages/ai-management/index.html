<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinMate - AI Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/assets/css/global-layout.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/assets/js/tab-logout.js"></script>
    <script src="/assets/js/helper_functions.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6'
                    }
                }
            }
        }
    </script>
    <style>
        /* Layout adjustments for proper spacing */
        .main-content {
            transition: margin-left 0.3s ease !important;
            position: relative !important;
            min-height: 100vh !important;
        }

        /* Force exact values with highest specificity */
        @media (min-width: 1025px) {
            /* Default expanded state */
            body .main-content {
                margin-left: 256px !important;
                padding-top: 64px !important;
                width: calc(100% - 256px) !important;
            }

            /* Collapsed state - MUST override default */
            body .main-content.sidebar-collapsed {
                margin-left: 80px !important;
                width: calc(100% - 80px) !important;
            }
        }

        /* Mobile: No margin, full width */
        @media (max-width: 1024px) {
            body .main-content,
            body .main-content.sidebar-collapsed {
                margin-left: 0 !important;
                width: 100% !important;
                padding-top: 64px !important;
            }
        }

        /* Ensure no extra spacing */
        .no-scroll-margin {
            margin: 0;
            padding: 0;
        }

        /* Override any Tailwind or other CSS conflicts */
        .main-content * {
            box-sizing: border-box !important;
        }

        /* Loading spinner animation */
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status indicators */
        .status-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .status-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .status-training {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        /* Animation for cards */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen no-scroll-margin">
<!-- Include Header -->
<div id="header-container"></div>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main Content -->
<div class="main-content">
    <div class="p-4 lg:p-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">AI Management</h1>
            <p class="text-gray-600">Manage and monitor your AI model training</p>
        </div>

        <!-- AI Status Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Current Model Status -->
            <div class="bg-white rounded-3xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Current Model</h3>
                    <div class="w-3 h-3 rounded-full bg-green-500" id="modelStatusIndicator"></div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-gray-600">Status: <span class="font-semibold text-green-600" id="modelStatus">Active</span></p>
                    <p class="text-sm text-gray-600">Last Updated: <span class="font-semibold" id="lastUpdated">Loading...</span></p>
                    <p class="text-sm text-gray-600">Accuracy: <span class="font-semibold text-blue-600" id="modelAccuracy">Loading...</span></p>
                </div>
            </div>

            <!-- Training Statistics -->
            <div class="bg-white rounded-3xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Training Stats</h3>
                    <i class="fas fa-chart-line text-blue-500"></i>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-gray-600">Total Trainings: <span class="font-semibold" id="totalTrainings">Loading...</span></p>
                    <p class="text-sm text-gray-600">Success Rate: <span class="font-semibold text-green-600" id="successRate">Loading...</span></p>
                    <p class="text-sm text-gray-600">Avg Duration: <span class="font-semibold" id="avgDuration">Loading...</span></p>
                </div>
            </div>

            <!-- Data Overview -->
            <div class="bg-white rounded-3xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Data Overview</h3>
                    <i class="fas fa-database text-purple-500"></i>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-gray-600">Transactions: <span class="font-semibold" id="totalTransactions">Loading...</span></p>
                    <p class="text-sm text-gray-600">Categories: <span class="font-semibold" id="totalCategories">Loading...</span></p>
                    <p class="text-sm text-gray-600">Features: <span class="font-semibold" id="totalFeatures">Loading...</span></p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Retrain Model -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Retrain Model Section -->
                <div class="bg-white rounded-3xl p-6 lg:p-8 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl lg:text-2xl font-bold text-gray-800">Retrain AI Model</h3>
                        <i class="fas fa-brain text-2xl text-purple-500"></i>
                    </div>
                    
                    <div class="mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-4 mb-4">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                Retraining will improve the model's accuracy using your latest transaction data. 
                                This process may take a few minutes.
                            </p>
                        </div>
                    </div>

                    <!-- Training Progress -->
                    <div id="trainingProgress" class="hidden mb-6">
                        <div class="flex items-center justify-center space-x-4 p-6 bg-blue-50 rounded-2xl">
                            <div class="spinner"></div>
                            <div>
                                <p class="font-semibold text-blue-800">Training in Progress...</p>
                                <p class="text-sm text-blue-600">Please wait while we retrain your model</p>
                            </div>
                        </div>
                    </div>

                    <!-- Training Results -->
                    <div id="trainingResults" class="hidden mb-6">
                        <div class="p-4 rounded-2xl" id="resultsContainer">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Retrain Button -->
                    <button id="retrainBtn" onclick="retrainModel()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-purple-700 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Start Retraining
                    </button>
                </div>

                <!-- Training History -->
                <div class="bg-white rounded-3xl p-6 lg:p-8 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl lg:text-2xl font-bold text-gray-800">Training History</h3>
                        <button onclick="refreshHistory()" class="text-blue-600 hover:text-blue-800 transition-colors">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                    
                    <div id="trainingHistory" class="space-y-4">
                        <!-- Training history will be loaded here -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-history text-3xl mb-2"></i>
                            <p>Loading training history...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Quick Actions & Info -->
            <div class="space-y-6">
                <!-- Model Performance -->
                <div class="bg-white rounded-3xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Model Performance</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">MSE Score:</span>
                            <span class="font-semibold" id="mseScore">Loading...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style="width: 85%" id="performanceBar"></div>
                        </div>
                        <p class="text-sm text-gray-500">Higher is better</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-3xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="exportTrainingData()" 
                                class="w-full bg-green-500 text-white py-3 px-4 rounded-2xl hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-download"></i>
                            <span>Export Training Data</span>
                        </button>
                        <button onclick="viewModelDetails()" 
                                class="w-full bg-blue-500 text-white py-3 px-4 rounded-2xl hover:bg-blue-600 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-info-circle"></i>
                            <span>Model Details</span>
                        </button>
                        <button onclick="resetModel()" 
                                class="w-full bg-red-500 text-white py-3 px-4 rounded-2xl hover:bg-red-600 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-trash-alt"></i>
                            <span>Reset Model</span>
                        </button>
                    </div>
                </div>

                <!-- Feature Importance -->
                <div class="bg-white rounded-3xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Top Features</h3>
                    <div id="featureImportance" class="space-y-3">
                        <!-- Feature importance will be loaded here -->
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">Loading features...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/assets/js/autho_helper.js"></script>
<script>
    // Check authentication
    document.addEventListener('DOMContentLoaded', function () {
        const loginTimestamp = sessionStorage.getItem('loginTimestamp');
        const token = sessionStorage.getItem('token');
        const userData = sessionStorage.getItem('userData');

        if (!token || !userData || !loginTimestamp) {
            console.log('No valid session found, redirecting to login');
            window.location.href = '/';
            return;
        }

        const loginTime = parseInt(loginTimestamp);
        const currentTime = Date.now();
        const sessionTimeout = 24 * 60 * 60 * 1000; // 24 hours

        if (currentTime - loginTime > sessionTimeout) {
            console.log('Session expired, redirecting to login');
            sessionStorage.clear();
            window.location.href = '/';
            return;
        }

        try {
            const user = JSON.parse(userData);
            
            // Check if user has permission to access AI management
            if (user.role !== 'ADMIN' && user.role !== 'admin') {
                console.log('Insufficient permissions for AI management');
                window.location.href = '/pages/home/';
                return;
            }

            console.log('Admin authorized to access AI management');
            
            // Load initial data
            loadModelStatus();
            loadTrainingHistory();
            
        } catch (error) {
            console.error('Error parsing user data:', error);
            sessionStorage.clear();
            window.location.href = '/';
        }
    });

    // API Configuration
    const API_BASE_URL = 'http://localhost:8080';
    
    function getAuthHeaders() {
        const token = sessionStorage.getItem('token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    // Load Model Status
    async function loadModelStatus() {
        try {
            // Since there's no specific endpoint for model status, we'll simulate it
            // In a real implementation, you'd have endpoints for model status
            document.getElementById('modelStatus').textContent = 'Active';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
            document.getElementById('modelAccuracy').textContent = '94.5%';
            document.getElementById('totalTrainings').textContent = '12';
            document.getElementById('successRate').textContent = '91.7%';
            document.getElementById('avgDuration').textContent = '2.3min';
            document.getElementById('totalTransactions').textContent = '1,250';
            document.getElementById('totalCategories').textContent = '8';
            document.getElementById('totalFeatures').textContent = '15';
            document.getElementById('mseScore').textContent = '0.0234';
            
        } catch (error) {
            console.error('Error loading model status:', error);
        }
    }

    // Retrain Model
    async function retrainModel() {
        const retrainBtn = document.getElementById('retrainBtn');
        const trainingProgress = document.getElementById('trainingProgress');
        const trainingResults = document.getElementById('trainingResults');
        
        // Reset previous results
        trainingResults.classList.add('hidden');
        
        // Show progress
        retrainBtn.disabled = true;
        retrainBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Training...';
        trainingProgress.classList.remove('hidden');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/ai/retrain-model`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Hide progress
            trainingProgress.classList.add('hidden');
            
            // Show results
            displayTrainingResults(data.result);
            
            // Update model status
            loadModelStatus();
            loadTrainingHistory();
            
        } catch (error) {
            console.error('Error retraining model:', error);
            trainingProgress.classList.add('hidden');
            showErrorResults(error.message);
        } finally {
            // Reset button
            retrainBtn.disabled = false;
            retrainBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Start Retraining';
        }
    }

    // Display Training Results
    function displayTrainingResults(result) {
        const trainingResults = document.getElementById('trainingResults');
        const resultsContainer = document.getElementById('resultsContainer');
        
        const successClass = result.status === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const iconClass = result.status === 'success' ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500';
        
        let featuresHtml = '';
        if (result.featureColumns && result.featureColumns.length > 0) {
            featuresHtml = result.featureColumns.slice(0, 5).map(feature => 
                `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${feature}</span>`
            ).join(' ');
        }
        
        let categoriesHtml = '';
        if (result.topCategories && result.topCategories.length > 0) {
            categoriesHtml = result.topCategories.slice(0, 3).map(category => 
                `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">${category}</span>`
            ).join(' ');
        }
        
        resultsContainer.className = `p-4 rounded-2xl border-2 ${successClass}`;
        resultsContainer.innerHTML = `
            <div class="flex items-start space-x-3">
                <i class="${iconClass} text-xl mt-1"></i>
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 mb-2">Training ${result.status === 'success' ? 'Completed' : 'Failed'}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">MSE Score: <span class="font-semibold">${result.mse || 'N/A'}</span></p>
                            <p class="text-gray-600">Duration: <span class="font-semibold">${result.trainingDurationSeconds ? result.trainingDurationSeconds.toFixed(2) + 's' : 'N/A'}</span></p>
                            <p class="text-gray-600">Transactions: <span class="font-semibold">${result.numTransactions || 'N/A'}</span></p>
                        </div>
                        <div>
                            <p class="text-gray-600">Timestamp: <span class="font-semibold">${result.trainingTimestamp || 'N/A'}</span></p>
                        </div>
                    </div>
                    ${featuresHtml ? `
                        <div class="mt-3">
                            <p class="text-sm text-gray-600 mb-2">Key Features:</p>
                            <div class="flex flex-wrap gap-1">${featuresHtml}</div>
                        </div>
                    ` : ''}
                    ${categoriesHtml ? `
                        <div class="mt-3">
                            <p class="text-sm text-gray-600 mb-2">Top Categories:</p>
                            <div class="flex flex-wrap gap-1">${categoriesHtml}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        trainingResults.classList.remove('hidden');
        trainingResults.classList.add('fade-in');
    }

    // Show Error Results
    function showErrorResults(errorMessage) {
        const trainingResults = document.getElementById('trainingResults');
        const resultsContainer = document.getElementById('resultsContainer');
        
        resultsContainer.className = 'p-4 rounded-2xl border-2 bg-red-50 border-red-200';
        resultsContainer.innerHTML = `
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-circle text-red-500 text-xl mt-1"></i>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Training Failed</h4>
                    <p class="text-sm text-gray-600">${errorMessage}</p>
                    <p class="text-xs text-gray-500 mt-2">Please try again or contact support if the issue persists.</p>
                </div>
            </div>
        `;
        
        trainingResults.classList.remove('hidden');
    }

    // Load Training History (Mock data for now)
    function loadTrainingHistory() {
        const historyContainer = document.getElementById('trainingHistory');
        
        // Mock data - replace with actual API call
        const mockHistory = [
            {
                timestamp: '2025-01-28 14:30:00',
                status: 'success',
                mse: 0.0234,
                duration: 125.5,
                transactions: 1250
            },
            {
                timestamp: '2025-01-25 10:15:00',
                status: 'success',
                mse: 0.0267,
                duration: 108.2,
                transactions: 1180
            },
            {
                timestamp: '2025-01-22 16:45:00',
                status: 'error',
                mse: null,
                duration: 45.1,
                transactions: 1150
            }
        ];
        
        historyContainer.innerHTML = mockHistory.map(training => {
            const statusClass = training.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusIcon = training.status === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            return `
                <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i class="${statusIcon} ${training.status === 'success' ? 'text-green-500' : 'text-red-500'}"></i>
                            <span class="font-semibold text-gray-800">${training.timestamp}</span>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${training.status.toUpperCase()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600">
                        <div>MSE: ${training.mse ? training.mse.toFixed(4) : 'N/A'}</div>
                        <div>Duration: ${training.duration.toFixed(1)}s</div>
                        <div>Transactions: ${training.transactions}</div>
                        <div class="text-right">
                            <button class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Refresh History
    function refreshHistory() {
        loadTrainingHistory();
    }

    // Quick Actions
    function exportTrainingData() {
        alert('Export functionality will be implemented based on your backend API');
    }

    function viewModelDetails() {
        alert('Model details modal will be implemented');
    }

    function resetModel() {
        if (confirm('Are you sure you want to reset the model? This action cannot be undone.')) {
            alert('Reset functionality will be implemented based on your backend API');
        }
    }
</script>
<script src="/assets/js/page-loader.js"></script>
<script src="/assets/js/header.js"></script>
<script src="/assets/js/sidebar.js"></script>
</body>
</html>