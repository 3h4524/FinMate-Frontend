<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Logs - FinMate</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/autho_helper.js" defer></script>
    <script src="../assets/js/helper_functions.js" defer></script>
    <style>
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
        .notification-slide-in { animation: slideIn 0.3s ease-out; }
        .notification-slide-out { animation: slideOut 0.3s ease-in; }
    </style>
</head>
<body class="font-sans text-gray-900 bg-green-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 bg-teal-900 text-white p-5 fixed h-full overflow-y-auto transition-transform transform md:translate-x-0 -translate-x-full z-50">
            <div class="flex items-center gap-2 mb-8 text-2xl font-bold">
                <i class="fas fa-chart-line text-lime-300"></i> FinMate
            </div>
            <nav>
                <ul class="space-y-2 flex-1">
                    <li><a href="index.html" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-tachometer-alt mr-3"></i> Dashboard</a></li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-bullseye mr-3"></i> Goals</a></li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-exchange-alt mr-3"></i> Transactions</a></li>
                    <li><a href="budget.html" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-calculator mr-3"></i> Budget</a></li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-chart-pie mr-3"></i> Reports</a></li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-user mr-3"></i> Profile</a></li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg hover:bg-teal-700 hover:text-lime-300 transition"><i class="fas fa-cog mr-3"></i> Settings</a></li>
                </ul>
            </nav>
            <button class="flex items-center w-full p-3 mt-2 rounded-lg hover:bg-teal-700 transition" onclick="logout()">
                <i class="fas fa-sign-out-alt mr-3"></i> Logout
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-5 transition-all">
            <header class="bg-white rounded-lg p-4 shadow-md flex justify-between items-center mb-5">
                <div>
                    <h1 class="text-xl font-semibold">System Logs Management</h1>
                    <div class="text-sm text-gray-600" id="current-date-time"></div>
                </div>
                <button id="menuToggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 md:hidden"><i class="fas fa-bars"></i></button>
            </header>

            <div class="flex flex-col gap-6">
                <!-- Filter Section -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-filter text-teal-600"></i> Log Filters
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="startDate" class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="startDate"
                                class="w-full p-3 rounded-lg border border-gray-300 bg-white shadow-sm focus:ring-2 focus:ring-green-500 transition" />
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                            <input type="date" id="endDate"
                                class="w-full p-3 rounded-lg border border-gray-300 bg-white shadow-sm focus:ring-2 focus:ring-green-500 transition" />
                        </div>
                        <div>
                            <label for="entityType" class="block text-sm font-semibold text-gray-700 mb-2">Entity Type</label>
                            <input type="text" id="entityType" placeholder="E.g., User, Transaction"
                                class="w-full p-3 rounded-lg border border-gray-300 bg-white shadow-sm focus:ring-2 focus:ring-green-500 transition" />
                        </div>
                        <div>
                            <label for="adminId" class="block text-sm font-semibold text-gray-700 mb-2">Admin ID</label>
                            <input type="number" id="adminId" placeholder="E.g., 1"
                                class="w-full p-3 rounded-lg border border-gray-300 bg-white shadow-sm focus:ring-2 focus:ring-green-500 transition" />
                        </div>
                        <div class="md:col-span-2 lg:col-span-4 flex justify-end items-end">
                            <button id="filterBtn"
                                class="bg-gradient-to-r from-green-700 to-lime-300 text-white px-5 py-2 rounded-lg shadow-md hover:shadow-lg hover:-translate-y-1 transition flex items-center gap-2">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button id="exportBtn"
                                class="ml-4 bg-gradient-to-r from-green-700 to-lime-300 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg hover:-translate-y-1 transition flex items-center gap-2">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-database text-teal-600"></i> Log Entries
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="logsTable" class="w-full text-center border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 font-semibold"># </th>
                                    <th class="p-3 font-semibold">Admin ID</th>
                                    <th class="p-3 font-semibold">Action</th>
                                    <th class="p-3 font-semibold">Entity Type</th>
                                    <th class="p-3 font-semibold">Entity ID</th>
                                    <th class="p-3 font-semibold">Details</th>
                                    <th class="p-3 font-semibold">Created At</th>
                                </tr>
                            </thead>
                            <tbody id="logsBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="pagination" class="flex justify-center mt-4 gap-2"></div>
                </div>

                <!-- Notification -->
                <div id="notification"
                    class="fixed top-5 right-5 hidden p-4 rounded-lg shadow-md bg-green-100 text-green-800 text-sm transition z-50"
                    role="alert">
                    <span id="notificationMessage"></span>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentPage = 0;
        let totalPages = 0;

        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const day = days[now.getDay()];
            const date = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('current-date-time').textContent = `${day}, ${date} ${month}, ${year}, ${hours}:${minutes} +07`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            updateDateTime();
            if (!checkAuth()) return;

            const user = getCurrentUser();
            if (user) {
                const userInfo = JSON.parse(localStorage.getItem('userData') || '{}');
                const userName = userInfo.name || userInfo.email?.split('@')[0] || 'Admin';
                loadSideBarSimple(userName);
                await loadLogs();
            }
        });

        async function loadLogs(page = 0, size = 10, startDate = '', endDate = '', entityType = '', adminId = '') {
            try {
                const params = new URLSearchParams({ page, size });
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (entityType) params.append('entityType', entityType);
                if (adminId) params.append('adminId', adminId);

                const response = await apiRequest(`http://localhost:8080/api/admin/logs?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const data = await response.json();
                if (!data.result || !data.result.content) throw new Error('Data format incorrect');

                const logs = data.result.content;
                totalPages = data.result.totalPages;

                const tbody = document.getElementById('logsBody');
                tbody.innerHTML = '';
                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${log.id}</td>
                        <td class="p-3">${log.id}</td>
                        <td class="p-3">${log.action}</td>
                        <td class="p-3">${log.entityType}</td>
                        <td class="p-3">${log.entityId || 'N/A'}</td>
                        <td class="p-3">${log.details || 'N/A'}</td>
                        <td class="p-3">${log.createdAt ? new Date(log.createdAt).toLocaleString() : 'N/A'}</td>`;
                    tbody.appendChild(tr);
                });

                renderPagination();
                showNotification('Logs loaded successfully', 'success');
            } catch (error) {
                showNotification(`Failed to load logs: ${error.message}`, 'error');
                console.error('Error loading logs:', error);
            }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i + 1;
                button.className = `px-3 py-1 ${i === currentPage ? 'bg-green-700 text-white' : 'bg-gray-200 text-gray-700'} rounded-lg hover:bg-green-600 hover:text-white transition`;
                button.onclick = () => {
                    currentPage = i;
                    loadLogs(currentPage, 10);
                };
                pagination.appendChild(button);
            }
        }

        document.getElementById('filterBtn')?.addEventListener('click', () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const entityType = document.getElementById('entityType').value;
            const adminId = document.getElementById('adminId').value;
            loadLogs(0, 10, startDate, endDate, entityType, adminId);
        });

        document.getElementById('exportBtn')?.addEventListener('click', async () => {
            try {
                const response = await apiRequest('http://localhost:8080/api/admin/logs/export', { responseType: 'blob' });
                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'admin_logs.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Export successful', 'success');
            } catch (error) {
                showNotification('Export failed. Please try again.', 'error');
                console.error('Error exporting file:', error);
            }
        });

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            notificationMessage.textContent = message;
            notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-md text-sm z-50 ${type === 'success' ? 'bg-green-100 text-green-800 notification-slide-in' : 'bg-red-100 text-red-700 notification-slide-in'}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('notification-slide-out');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
        }

        // Toggle sidebar for mobile
        document.getElementById('menuToggle')?.addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.toggle('-translate-x-full');
        });

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            clearCache();
            window.location.href = '../pages/login.html';
        }
    </script>
</body>
</html>